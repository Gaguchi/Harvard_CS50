{% extends "network/layout.html" %}

{% block body %}
    <div id="root"></div>
    
    <script type="text/babel">
    
        class App extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    posts: [],
                    newPostContent: "",
                    username: ""
                };
            }

            componentDidMount() {
                fetch('/get_username')
                .then(response => response.json())
                .then(data => this.setState({ username: data.username }));

                fetch('/posts')
                .then(response => response.json())
                .then(data => {
                    const sortedData = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    this.setState({ posts: sortedData });
                });
            }

            handleInputChange = (event) => {
                this.setState({ newPostContent: event.target.value });
            }

            createPost = () => {
                fetch('/posts', {
                    method: 'POST',
                    body: JSON.stringify({
                        content: this.state.newPostContent
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    this.setState(prevState => ({
                        posts: [data, ...prevState.posts],
                        newPostContent: ""
                    }))
                    this.componentDidMount();
                });
            }

            likePost = (post_id) => {
                fetch(`/like_post/${post_id}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    // Re-fetch the posts to update the UI
                    this.componentDidMount();
                });
            }
            
            followUser = (user_id) => {
            if (user_id !== undefined) {
                fetch(`/follow_user/${parseInt(user_id)}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {this.componentDidMount();});
            } else {
                console.error('User ID is undefined');
            }
        }


            filterLikedPosts = () => {
                fetch('/liked_posts')
                .then(response => response.json())
                .then(data => this.setState({ posts: data }));
            }

            filterFollowedPosts = () => {
                fetch('/followed_posts')
                .then(response => response.json())
                .then(data => this.setState({ posts: data }));
            }

            deletePost = (post_id) => {
                fetch(`/delete_post/${post_id}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    this.componentDidMount();  // Re-fetch the posts to update the UI
                });
            }

            render() {
                return (
                    <div>
                        <h1>All Posts</h1>
                        <button onClick={this.filterLikedPosts}>Show Liked Posts</button>
                        <button onClick={this.filterFollowedPosts}>Show Followed Posts</button>
                        <div class="feed">
                            <div class="feed__header">
                              <h2>Home</h2>
                            </div>
                      
                            <div class="tweetBox">
                              <form>
                                <div class="tweetbox__input">
                                  <img
                                    src="https://i.pinimg.com/originals/a6/58/32/a65832155622ac173337874f02b218fb.png"
                                    alt=""
                                  />
                                  <input type="text" value={this.state.newPostContent} onChange={this.handleInputChange} placeholder="What's happening?" />
                                </div>
                                <button onClick={this.createPost} class="tweetBox__tweetButton">Tweet</button>
                              </form>
                            </div>
                            
                            {this.state.posts.map((post, index) => (
                                
                                <div class="post">
                                    <div class="post__avatar">
                                    <img
                                        src="https://i.pinimg.com/originals/a6/58/32/a65832155622ac173337874f02b218fb.png"
                                        alt=""
                                    />
                                    </div>
                            
                                    <div class="post__body">
                                    <div class="post__header">
                                        <div class="post__headerText">
                                        <h3>
                                            {post.user__username}
                                        </h3>
                                        </div>
                                        <div class="post__headerDescription">
                                        <p>{post.content}</p>
                                        </div>
                                    </div>
                                    <div class="post__footer">
                                        <span class="material-icons"> <button onClick={() => this.likePost(post.id)}>Like</button> </span>
                                        <span class="material-icons"> <button onClick={() => this.followUser(post.user__id)}>Follow</button> </span>
                                        <span class="material-icons"> {this.state.username === post.user__username && <button onClick={() => this.deletePost(post.id)}>Delete</button>} </span>
                                    </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
{% endblock %}
